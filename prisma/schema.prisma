// npx prisma migrate reset
//npx prisma migrate dev --name init
//npx prisma db push
//npx prisma db seed

// ==============================
// GENERATOR & DATASOURCE
// ==============================
generator client {
  provider = "prisma-client"
  output   = "generated"
}

datasource db {
  provider = "postgresql"
}

// ==============================
// ENUMS
// ==============================
enum UserRole {
  USER
  LANDLORD
  ADMIN
}

// ==============================
// USER
// ==============================
model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  imgUrl    String?  @map("img_url")
  isLocked  Boolean  @default(false)
  role      UserRole @default(USER)

  properties Property[]
  favorites  Favorite[]
  phones     Phone[]
  propertyReport     PropertyReport[]

  createdAt DateTime @default(now())  @map("created_at")
  updatedAt DateTime @updatedAt       @map("updated_at")

  @@index([email])
  @@map("users")
}

// ==============================
// PHONE
// ==============================
model Phone {
  id          Int    @id @default(autoincrement())
  phoneNumber String @unique @map("phone_number")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())  @map("created_at")
  updatedAt DateTime @updatedAt       @map("updated_at")

  @@index([userId])
  @@map("phones")
}

// ==============================
// LOCATION
// ==============================
model Province {
  id     Int    @id
  nameKh String @map("name_kh")
  nameEn String @map("name_en")

  districts District[]

  @@map("provinces")
}

model District {
  id         Int    @id
  provinceId Int    @map("province_id")
  nameKh     String @map("name_kh")
  nameEn     String @map("name_en")

  province      Province      @relation(fields: [provinceId], references: [id])
  properties    Property[]
  locationViews LocationView[]

  @@index([provinceId])
  @@unique([provinceId, nameEn])
  @@unique([provinceId, nameKh])
  @@map("districts")
}

model LocationView {
  id         Int      @id @default(autoincrement())
  districtId Int      @unique @map("district_id")
  views      Int      @default(0)
  updatedAt  DateTime @updatedAt   @map("updated_at")

  district District @relation(fields: [districtId], references: [id])

  @@index([views])
  @@map("location_views")
}

// ==============================
// PROPERTY
// ==============================
model Property {
  id         String @id @default(uuid())
  userId     String @map("user_id")
  districtId Int    @map("district_id")

  address     String
  locationUrl String? @map("location_url")

  title       String
  description String?

  price    Float
  deposit  Float?

  bedroom  Int  @default(1)
  bathroom  Int  @default(1)
  isAvailable  Boolean  @default(true) @map("is_available")

  isFeatured Boolean  @default(false)
  featuredAt DateTime?

  totalViews Int @default(0) @map("total_views")

  propertyTypeId Int @map("property_type_id")
  sizeSqm        Int
  furnished      Boolean @default(true)
  isPublished    Boolean @default(true)

  user         User         @relation(fields: [userId], references: [id])
  district     District     @relation(fields: [districtId], references: [id])
  propertyType PropertyType @relation(fields: [propertyTypeId], references: [id])

  images            PropertyImage[]
  favorites         Favorite[]
  propertyAmenities PropertyAmenity[]
  propertyReport PropertyReport[]
  propertyViews PropertyView[]

  createdAt DateTime @default(now())  @map("created_at")
  updatedAt DateTime @updatedAt       @map("updated_at")

  @@index([districtId, isAvailable])
  @@index([propertyTypeId])
  @@index([price])
  @@index([isPublished])
  @@index([districtId, propertyTypeId])
  @@index([isPublished, price])
  @@map("properties")
}

// ==============================
// PROPERTY TYPE
// ==============================
model PropertyType {
  id        Int     @id @default(autoincrement())
  code      String  @unique
  nameEn    String  @unique @map("name_en")
  nameKh    String  @unique @map("name_kh")
  slug      String  @unique
  isRemoved Boolean @default(false) @map("is_removed")

  properties Property[]

  createdAt DateTime @default(now())  @map("created_at")

  @@index([slug])
  @@index([isRemoved])
  @@map("property_types")
}

// ==============================
// PROPERTY VIEWS
// ==============================
model PropertyView {
  id         Int      @id @default(autoincrement())
  propertyId String
  views      Int
  date       DateTime

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, date])
  @@index([date])
}

// ==============================
// PROPERTY REPORT
// ==============================
model PropertyReport {
  id         Int      @id @default(autoincrement())
  propertyId String   @map("property_id")
  userId     String   @map("user_id")
  description   String 

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user     User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())  @map("created_at")

  @@index([propertyId, userId])
}

// ==============================
// PROPERTY IMAGE
// ==============================
model PropertyImage {
  id         String @id @default(uuid())
  propertyId String @map("property_id")
  imageKey   String @map("image_key")

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([propertyId])
  @@map("property_images")
}

// ==============================
// AMENITIES
// ==============================
model Amenity {
  id     Int    @id @default(autoincrement())
  code   String @unique
  nameEn String @unique @map("name_en")
  nameKh String @unique @map("name_kh")
  icon   String

  properties PropertyAmenity[]

  createdAt DateTime @default(now())

  @@map("amenities")
}

model PropertyAmenity {
  propertyId String @map("property_id")
  amenityId  Int    @map("amenity_id")

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  amenity  Amenity  @relation(fields: [amenityId], references: [id], onDelete: Cascade)

  @@id([propertyId, amenityId])
  @@map("property_amenities")
}

// ==============================
// FAVORITES
// ==============================
model Favorite {
  id         String @id @default(uuid())
  userId     String @map("user_id")
  propertyId String @map("property_id")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, propertyId])
  @@map("favourites")
}
